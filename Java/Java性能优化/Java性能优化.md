## Java性能优化

- #### 性能指标

  1. 预期吞吐量
  2. 请求和响应预期延迟
  3. 支持并发用户或并发任务
  4. 并发任务最大时，可接受的吞吐量与延迟
  5. 最差情况延迟
  6. 垃圾收集延迟范围及频率

- #### **性能分析**

  - 直顶向下

    > 监测应用负载情况，检查应用配置变化。在特定负载场景下对应用进行监控，监控范围包括操作系统，Java虚拟机，JavaEE容器。通常需要更改代码配置（JVM垃圾回收调优，JVM命令行选项调优，操作系统调优，第三方库和Java代码调优）
  
  - 直底向上
  
    > 根据计算机资源环境进行应用调优（CPU数量，架构，内存）。需要收集和监控CPU性能统计数据（CPU高速缓存命中率，执行应用所需指令及扩展指令）。主要是改善CPU使用率，一般涉及汇编，编译器优化。不涉及应用源码。
  
- #### **操作系统性能指标**

  - CPU使用率

    > 1. 用户态使用率（应用程序占用CPU时间与总时间百分比）
    > 2. 系统态使用率（操作系统占用CPU时间与总时间百分比）
    >
    > - **系统态占用高场景：共享资源存在竞争或IO设备之间有大量交互，提高应用性能和扩展一个目标是尽可能降低系统态CPU使用率**

  - IPC（时钟指令数）/ CPI（每指令时钟周期）

    > CPU等待内存数据中所消耗时间（停滞）会统计到CPU使用率中（通常指令未命中需要浪费好几百个时钟周期）。**提高计算密集型应用性能策略是减少停滞或改善CPU高速缓存使用率**

  - CPU调度程序运行队列
  
    > 运行队列：已就绪进程，正等待CPU资源运行。
    >
    > **运行队列长度长时间超过处理器数量的3~4倍需要排查问题**
    >
    > 1. 增加CPU减少处理器负载量
    > 2. 改进CPU使用率（减少应用运行所需要CPU周期时间，数据结构及算法改进）
  
  - 内存使用率
  
    > 页中断（页置换）：影响应用吞吐率及响应时间（JVM垃圾收集器在页面交换时会停止所有正在运行的应用线程）  
  
  - 进程上下文切换（锁竞争）
  
    > 任务中断带来的CPU开销（根据任务优先级对正在处理的任务中断而执行其他任务，后续返回该任务继续执行）
    >
    > 让步式上下文切换：执行线程主动释放CPU资源
    >
    > 抢占式上下文切换：线程因分配的时间片用尽被迫放弃CPU资源或让其他更高级的线程所抢占
    
  - 网络IO使用率
  
  ---
  
- #### **监测工具**

  **Linux命令行监控**

  - vmstat  3  10  （以3秒为时间间隔，连续收集10次性能数据）

    ![image-20230130105712098](img\image-20230130105712098.png) 

    1. r：运行队列中等待进程数
    2. b：在等待IO的进程数
    3. swpd：已使用的交换内存（kb）
    4. free：空闲的物理内存（kb）
    5. buff：内存写入到硬盘中间数据（内存不足时指标过高）
    6. cache：用作高数缓存的内存数（提高CPU执行效率）
    7. si：从磁盘读取到内存页数（缺页次数，内存不足时指标高）
    8. so：从内存交换到磁盘的页数（缺页次数，内存不足时指标高）
    9. bi：读取磁盘块数
    10. bo：写入磁盘快数
    11. in：中断次数
    12. cs：每秒上下文切换次数
    13. us：用户态使用率
    14. sy：系统态使用率
    15. id：空闲CPU使用率
    16. wa：等待IO消耗CPU时间
    17. st：从虚拟设备中获取的时间

  - pidstat  -w （每秒输出所有虚拟处理器**上下文切换**）  

    ![image-20230130150401070](img\image-20230130150401070.png) 
  
    1. cswch/s ：每秒主动任务上下文切换数量
    2. nvcswch/s：每秒被动任务上下文切换数量
  
    | 参数       | 说明                                     |
    | ---------- | ---------------------------------------- |
    | -u（默认） | 显示各个进程的cpu使用统计                |
    | -r         | 显示各个进程的内存使用统计               |
    | -d         | 显示各个进程的IO使用情况                 |
    | -p         | 指定进程号                               |
    | -w         | 显示每个进程的上下文切换情况             |
    | -t         | 显示选择任务的线程的统计信息外的额外信息 |
    | -I         | 在SMP环境，表示任务的CPU使用率/内核数量  | 
    
  
  - netstat （监测网络I/O使用情况）
  
    | 参数          | 说明                                            |
    | ------------- | ----------------------------------------------- |
    | **-a**        | **显示所有网络连接和监听的所有端口 （Socket）** |
    | -A <网络类型> | 列出该网络类型连线中的相关地址                  |
    | -c            | 持续列出网络状态                                |
    | -C  / --cache | 显示路由器配置的快取信息                        |
    | -g            | 显示多重广播功能群组组员名单                    |
    | -i            | 显示网络界面信息表单                            |
    | **-l**        | **显示监控中的服务器的Socket**                  |
    | **-n**        | **直接使用ip地址，而不通过域名服务器**          |
    | -N            | 显示网络硬件外围设备的符号连接名称              |
    | **-p**        | **显示正在使用Socket的程序识别码和程序名称**    |
    | -r            | 显示Routing Table                               |
    | **-s**        | **显示网络工作信息统计表**                      |
    | **-t**        | **显示TCP传输协议的连线状况**                   |
    | -u            | 显示UDP传输协议的连线状况                       |
  
    ![image-20230130153051181](img\image-20230130153051181.png)
  
    
  
    


​     

​    

​    

​    

​    


​    

​    

​    

