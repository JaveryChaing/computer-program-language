## 消息队列

消息队列(MQ)是一种系统间相互协作的通信机制，应用在异步处理，系统解耦，流量削峰，日志收集，事务最终一致性。消息队列的主要组件有Broker（消息处理中心，负责消息的接收，存储，转发），Producer，Consumer。

- #### **AMQP** (Advanced Message Queuing Protocol)  

  > 传输层协议是一个网络级协议，它定义了数据的传输格式，消息队列的客户端可以基于这个协议与消息代理和 AMQP 的相关模型进行交 互通信，该协议的内容包括数据， 吭处理、信道 用、内容编码、心跳检测、数据表示和错误处 理
  >
  > **[AMQP](https://www.amqp.org/) 主要组件**
  >
  > - Message：MQ服务所处理数据单元
  > - Publisher：向交换器发布消息的客户端应用程序
  > - Exchange：接收Publisher发送的消息并将这些消息路由到服务器中的队列
  > - Binding：交换机与消息队列的映射
  > - Broker：消息代理，表示消息队列服务器实体，接受客户端连接，实现 AMQP消息队列和路由功能的过程
  > - Queue：消息容器，也是消息的终点。
  > - Channel：独立的双向数据流通道，建立在TCP通讯上，一个连接可以有多个信道
  > - Consumer
  >
  > 
  >
  > **AMQP消息流转**
  >
  > <img src="img\image-20230102140853342.png" alt="image-20230102140853342" style="zoom:67%;" /> 
  >
  > *Publish发送数据到Broker，Broker中的Exchange根据路由Key与Queue的映射关系（Binding）将消息存储在目标Queue，Consumer向Broker发送订阅消息时指定监听对应Queue，**当Queue中有数据时，Broker主动推送消息到Consumer**。Publish发布消息时可以指定消息属性（routingkey），内容载体对Broker不可见。**Exchange对不能路由的消息返回或丢弃**。单条消息可以被复制到多个Queue中，以广播形式推送给所有的消费者。Queue存在持久化队列和临时消息队列，持久化队列可以被多个消费者共享，不管是否有消费者接收，它都可以独立存在。**临时消费队列只对某个消费者所独有，当消费者断开连接时，消息队列将被删除***
  >
  > 
  >
  > **AMQP消息数据格式**
  >
  > ![image-20230102142832846](img\image-20230102142832846.png) 
  >
  > - 帧头（Header，7字节）
  > - 任意大小负载（payload）
  > - 错误校验帧

- #### **MQTT** (Message Queuing Telemetry Transport 消息队列遥测传输)

  > 轻量、简单、开放和易于实现。应用于很多机器计算能力有限、低带宽、网络不可靠的远程通信应用场景中。
  >
  > 基于MQTT协议实现的中间件服务器有Apache ActiveMQ，RabbitMQ，Apache Apollc，HiveMQ，ThingMQ，VemeMQ。
  >
  >  ![image-20230102144132517](img\image-20230102144132517.png) 
  >
  > 
  >
  > **[MQTT](https://mqtt.org/)组件**
  >
  > - Broker：服务代理
  > - Network Connection：网络连接（使用的底层网络传输协议 TCP/UDP）
  > - Application Message：应用消息，分为主题和负载两部分
  > - Topic：应用消息的类型，由消费者订阅
  > - Payload：负载内容，消费者接收到的内容
  > - Client：包含Publish/Subscriber实现
  > - Server：转发应用消息给客户端，处理客户端连接请求和订阅请求
  > - Session：用于客户端与服务器之间逻辑层面通讯
  > - Subscription：订阅包含一个主题过滤器和Qos服务质量等级。
  > - MQTT Control Packet：网络连接发送的消息数据包
  >
  >  
  >
  > **MQTT数据流转**
  >
  > 1. 建立连接，客户端发送服务器第一个报文必须是CONNECT，服务器发送CONNACK报文响应客户端
  >
  > 2. 发布消息，客户端发送Publish报文，按照QoS等级服务器将发送对应的应答报文
  >
  >    - QoS等级
  >
  >      1. 至多一次(0)：最高的传输性能，接收者不需要应答消息，发送者也不保留消息和重发消息（最多1次通信）
  >
  >      2. 至少一次(1)：消息至少送到到一次（发送者保留消息，直到接收者返回Puback报文，在规定时间内没接收到Puback报文将重新发送此报文，至少2次通信）
  >
  >      3. 只有一次(2)：可保证每条消息只被接收到一次（最慢的服务等级，也是最安全的，至少4次通信）
  >
  >         ![image-20230102153902545](img\image-20230102153902545.png) 
  >
  > 3. 主题订阅，客户端发送Subscribe报文进行注册对应主题（订阅报文中包含订阅者接收到的报文质量等级）
  >
  > 4. 心跳检测，客户端发送PingReq报文给服务器
  >
  >    1. 确认网络连接没有断开
  >    2. 确认服务器，客户端能正常通讯
  >
  >  5. 断开连接，客户端向服务器发送Disconnect报文，表示客户端断开连接
  >
  >    
  >
  > **MQTT数据格式**
  >
  > ![image-20230102152242604](img\image-20230102152242604.png) 
  >
  > 固定报头结构
  >
  > ![image-20230102152327415](img\image-20230102152327415.png) 
  >
  > 4~7比特位表示报文类型
  >
  > ![image-20230102152449211](img\image-20230102152449211.png) 
  >
  > 0~3比特位标识位（无效的标识位将关闭网络连接）
  >
  > ![image-20230102152627699](img\image-20230102152627699.png) 
  >
  > - Publish类型报文标识，用来标识通信质量
  >
  >   - DUP：重发标识，用来保证消息可靠传输。
  >   - Qos：服务质量等级
  >   - Retain：保留表示
  >   - 剩余长度
  >
  >   
  >

